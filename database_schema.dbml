// Documentação da Modelagem de Banco de Dados - Sistema de Gerenciamento de Condomínios
// Para uso em dbdiagram.io
// Data: 2025-01-21

Project CondominioManager {
  database_type: 'PostgreSQL'
  Note: '''
    Sistema completo de gerenciamento de condomínios
    Inclui gestão de moradores, visitantes, finanças, reservas e comunicações
  '''
}

// ============================================
// APP: USERS - Gestão de Usuários
// ============================================

Table users_person {
  id integer [primary key, increment]
  password varchar(128) [not null, note: 'Hash da senha']
  last_login datetime [null]
  is_superuser boolean [not null, default: false]
  is_staff boolean [not null, default: false]
  is_active boolean [not null, default: false, note: 'Usuários não-admin são criados inativos']
  date_joined datetime [not null, default: `now()`]

  // Campos customizados
  name varchar(255) [not null, note: 'Nome completo do usuário']
  email varchar(255) [unique, not null, note: 'Email usado como username']
  cpf varchar(11) [unique, null, note: 'CPF apenas números']
  telephone varchar(11) [null, note: 'Telefone de contato']
  user_type varchar(10) [not null, default: 'resident', note: 'resident, employee ou admin']
  position varchar(50) [null, note: 'Cargo (obrigatório para funcionários)']

  // Relacionamentos
  condominium_id integer [null, ref: > core_condominium.id, note: 'Condomínio associado (obrigatório para resident e employee)']
  apartment_id integer [unique, null, ref: - core_apartment.id, note: 'Apartamento (obrigatório para resident) - OneToOne']
  registered_by_id integer [null, ref: > users_person.id, note: 'Quem registrou este usuário']

  created_at datetime [not null, default: `now()`]
  updated_at datetime [not null, default: `now()`]

  indexes {
    email [unique]
    cpf [unique]
    user_type
    condominium_id
  }

  Note: 'Modelo personalizado de usuário baseado em AbstractUser'
}

Table users_person_managed_condominiums {
  id integer [primary key, increment]
  person_id integer [ref: > users_person.id, note: 'Administrador']
  condominium_id integer [ref: > core_condominium.id, note: 'Condomínio gerenciado']

  indexes {
    (person_id, condominium_id) [unique]
  }

  Note: 'ManyToMany: Condomínios que um admin pode gerenciar'
}

// ============================================
// APP: CORE - Modelos Principais
// ============================================

Table core_address {
  id integer [primary key, increment]
  street varchar(255) [not null, note: 'Rua']
  number integer [not null, note: 'Número']
  complement varchar(100) [null, note: 'Complemento opcional']
  neighborhood varchar(100) [not null, note: 'Bairro']
  city varchar(100) [not null, note: 'Cidade']
  state varchar(100) [not null, note: 'Estado']
  zip_code varchar(20) [not null, note: 'CEP']

  Note: 'Endereços para condomínios'
}

Table core_condominium {
  id integer [primary key, increment]
  name varchar(255) [not null, note: 'Nome do condomínio']
  cnpj varchar(20) [unique, not null, note: 'CNPJ do condomínio']
  code_condominium varchar(20) [unique, not null, note: 'Código único - gerado automaticamente']
  created_at datetime [not null, default: `now()`]

  // Relacionamentos
  address_id integer [unique, not null, ref: - core_address.id, note: 'OneToOne com Address']
  created_by_id integer [not null, ref: > users_person.id, note: 'Admin que criou o condomínio']

  indexes {
    cnpj [unique]
    code_condominium [unique]
  }

  Note: 'Condomínios do sistema - cada um possui código único gerado automaticamente'
}

Table core_apartment {
  id integer [primary key, increment]
  number integer [not null, note: 'Número do apartamento']
  block varchar(10) [not null, note: 'Bloco']
  tread integer [null, note: 'Andar/Piso']
  entry_date date [not null, default: `now()`]
  exit_date date [null, note: 'Data de saída (deve ser posterior à entrada)']
  occupation varchar(20) [not null, default: 'unoccupied', note: 'occupied ou unoccupied']

  // Relacionamentos
  condominium_id integer [not null, ref: > core_condominium.id]

  indexes {
    (number, block, condominium_id) [unique, name: 'unique_apartment_per_condo']
    condominium_id
  }

  Note: 'Apartamentos/Unidades dos condomínios'
}

Table core_visitor {
  id integer [primary key, increment]
  name varchar(255) [not null, note: 'Nome do visitante']
  cpf varchar(11) [not null, note: 'CPF apenas números']
  telephone varchar(11) [null, note: 'Telefone de contato']

  // Relacionamentos
  condominium_id integer [not null, ref: > core_condominium.id]
  registered_by_id integer [not null, ref: > users_person.id, note: 'Quem cadastrou o visitante']

  indexes {
    (cpf, condominium_id) [unique, note: 'CPF único por condomínio']
    condominium_id
  }

  Note: 'Visitantes cadastrados no condomínio'
}

Table core_visit {
  id integer [primary key, increment]
  observation text [null, note: 'Observações sobre a visita']
  entry_date datetime [not null, default: `now()`, note: 'Data/hora de entrada']
  exit_date datetime [null, note: 'Data/hora de saída (deve ser posterior à entrada)']

  // Relacionamentos
  condominium_id integer [not null, ref: > core_condominium.id]
  visitor_id integer [not null, ref: > core_visitor.id]
  apartment_id integer [not null, ref: > core_apartment.id, note: 'Apartamento visitado']
  registered_by_id integer [not null, ref: > users_person.id, note: 'Quem registrou a visita']

  indexes {
    entry_date
    condominium_id
    visitor_id
    apartment_id
  }

  Note: 'Registro de visitas aos apartamentos'
}

Table core_occurrence {
  id integer [primary key, increment]
  title varchar(255) [not null, note: 'Título da ocorrência']
  description text [not null, note: 'Descrição detalhada']
  status varchar(20) [not null, default: 'aberta', note: 'aberta, em_andamento, resolvida, fechada']
  date_reported datetime [not null, default: `now()`]

  // Relacionamentos
  condominium_id integer [not null, ref: > core_condominium.id]
  reported_by_id integer [not null, ref: > users_person.id, note: 'Quem reportou']

  indexes {
    date_reported
    status
    condominium_id
  }

  Note: 'Ocorrências e problemas reportados no condomínio'
}

Table core_reservation {
  id integer [primary key, increment]
  space varchar(20) [not null, note: 'salão_de_festas, churrasqueira, piscina, quadra, playground, academia']
  start_time datetime [not null, note: 'Data/hora início']
  end_time datetime [not null, note: 'Data/hora fim (deve ser posterior ao início)']

  // Relacionamentos
  condominium_id integer [not null, ref: > core_condominium.id]
  resident_id integer [not null, ref: > users_person.id, note: 'Morador que fez a reserva']

  indexes {
    (space, start_time, end_time)
    condominium_id
    resident_id
  }

  Note: 'Reservas de áreas comuns do condomínio - valida conflitos de horário'
}

Table core_finance {
  id integer [primary key, increment]
  value decimal(10,2) [not null, note: 'Valor (deve ser > 0)']
  date datetime [not null, default: `now()`]
  description text [not null, note: 'Descrição obrigatória']
  document varchar(100) [null, note: 'Path do arquivo de comprovante']

  // Relacionamentos
  condominium_id integer [not null, ref: > core_condominium.id]
  creator_id integer [not null, ref: > users_person.id, note: 'Quem criou o registro']

  indexes {
    date
    condominium_id
  }

  Note: 'Registros financeiros (despesas e receitas) do condomínio'
}

Table core_vehicle {
  id integer [primary key, increment]
  plate varchar(10) [not null, note: 'Placa do veículo']
  model varchar(50) [not null, note: 'Modelo']
  color varchar(20) [not null, note: 'Cor']

  // Relacionamentos
  condominium_id integer [not null, ref: > core_condominium.id]
  registered_by_id integer [not null, ref: > users_person.id, note: 'Quem cadastrou']
  owner_id integer [not null, ref: > users_person.id, note: 'Proprietário do veículo']

  indexes {
    (plate, condominium_id) [unique, name: 'unique_plate_per_condo']
    condominium_id
    owner_id
  }

  Note: 'Veículos cadastrados dos moradores'
}

Table core_order {
  id integer [primary key, increment]
  signature_image varchar(100) [null, note: 'Path da imagem da assinatura']
  order_code varchar(20) [not null, note: 'Código da encomenda']
  order_date datetime [not null, default: `now()`]
  status varchar(20) [not null, default: 'recebido', note: 'recebido ou entregue']

  // Relacionamentos
  condominium_id integer [not null, ref: > core_condominium.id]
  registered_by_id integer [not null, ref: > users_person.id, note: 'Quem recebeu a encomenda']
  owner_id integer [not null, ref: > users_person.id, note: 'Destinatário']

  indexes {
    order_date
    status
    condominium_id
    owner_id
  }

  Note: 'Controle de encomendas recebidas na portaria'
}

Table core_notice {
  id integer [primary key, increment]
  title varchar(255) [not null, note: 'Título do aviso']
  content text [not null, note: 'Conteúdo do aviso']
  file_complement varchar(100) [null, note: 'Arquivo anexo opcional']
  created_at datetime [not null, default: `now()`]
  updated_at datetime [not null, default: `now()`]

  // Relacionamentos
  condominium_id integer [not null, ref: > core_condominium.id]
  author_id integer [not null, ref: > users_person.id, note: 'Autor do aviso']

  indexes {
    created_at
    condominium_id
  }

  Note: 'Avisos gerais do condomínio'
}

Table core_communication {
  id integer [primary key, increment]
  communication_type varchar(20) [not null, default: 'message', note: 'notice ou message']
  title varchar(255) [not null, note: 'Título']
  message text [not null, note: 'Mensagem']
  all_residents boolean [not null, default: false, note: 'Enviar para todos os moradores']
  created_at datetime [not null, default: `now()`]

  // Relacionamentos
  condominium_id integer [not null, ref: > core_condominium.id]
  sender_id integer [not null, ref: > users_person.id, note: 'Remetente']

  indexes {
    created_at
    condominium_id
    sender_id
  }

  Note: 'Comunicações internas entre administração e moradores'
}

Table core_communication_recipients {
  id integer [primary key, increment]
  communication_id integer [ref: > core_communication.id]
  person_id integer [ref: > users_person.id, note: 'Destinatário']

  indexes {
    (communication_id, person_id) [unique]
  }

  Note: 'ManyToMany: Destinatários de cada comunicação'
}

Table core_resident {
  id integer [primary key, increment]
  name varchar(255) [not null, note: 'Nome do dependente']
  cpf varchar(11) [unique, not null, note: 'CPF único no sistema']
  email varchar(255) [null, note: 'Email opcional']
  phone varchar(11) [null, note: 'Telefone opcional']
  created_at datetime [not null, default: `now()`]

  // Relacionamentos
  condominium_id integer [not null, ref: > core_condominium.id]
  registered_by_id integer [not null, ref: > users_person.id, note: 'Morador principal']
  apartment_id integer [not null, ref: > core_apartment.id, note: 'Apartamento']

  indexes {
    cpf [unique]
    condominium_id
    apartment_id
  }

  Note: 'Dependentes/Moradores secundários (não possuem login no sistema)'
}

// ============================================
// RELACIONAMENTOS E CARDINALIDADES
// ============================================

// Condominium (1) -> (N) Apartment
// Condominium (1) -> (N) Visitor
// Condominium (1) -> (N) Visit
// Condominium (1) -> (N) Occurrence
// Condominium (1) -> (N) Reservation
// Condominium (1) -> (N) Finance
// Condominium (1) -> (N) Vehicle
// Condominium (1) -> (N) Order
// Condominium (1) -> (N) Notice
// Condominium (1) -> (N) Communication
// Condominium (1) -> (N) Resident
// Condominium (1) -> (N) Person (via condominium_id)
// Condominium (N) <-> (N) Person (via managed_condominiums - admins)

// Person (1) -> (1) Apartment (OneToOne - main_resident)
// Person (1) -> (N) Visitor (via registered_by)
// Person (1) -> (N) Visit (via registered_by)
// Person (1) -> (N) Occurrence (via reported_by)
// Person (1) -> (N) Reservation (via resident)
// Person (1) -> (N) Finance (via creator)
// Person (1) -> (N) Vehicle (via owner e registered_by)
// Person (1) -> (N) Order (via owner e registered_by)
// Person (1) -> (N) Notice (via author)
// Person (1) -> (N) Communication (via sender)
// Person (N) <-> (N) Communication (via recipients)
// Person (1) -> (N) Resident (via registered_by)
// Person (1) -> (N) Person (via registered_by - self-reference)

// Apartment (1) -> (N) Visit
// Apartment (1) -> (N) Resident

// Visitor (1) -> (N) Visit

// Address (1) -> (1) Condominium (OneToOne)

